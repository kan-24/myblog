import{J as w,K as m,L as l,p as f,M as a}from"./index-D9tgDiJn.js";const n="https://api.example.com/api";function p(t){return t?{Authorization:`Bearer ${t}`}:{}}async function S(t,s){const e=await fetch(`${n}/posts`,{method:"POST",headers:{"Content-Type":"application/json",...p(s)},body:JSON.stringify(t)});if(!e.ok){const o=await h(e);throw new Error(o)}return await e.json()}async function P(t=1,s=20){const e=new URLSearchParams({page:String(t),size:String(s)}),o=await fetch(`${n}/posts?${e.toString()}`);if(!o.ok){const i=await h(o);throw new Error(i)}return await o.json()}async function E(t){const s=await fetch(`${n}/posts/${t}`);if(!s.ok){const e=await h(s);throw new Error(e)}return await s.json()}async function $(t,s,e){const o=await fetch(`${n}/posts/${t}`,{method:"PUT",headers:{"Content-Type":"application/json",...p(e)},body:JSON.stringify(s)});if(!o.ok){const i=await h(o);throw new Error(i)}return await o.json()}async function g(t,s){const e=await fetch(`${n}/posts/${t}/likes`,{method:"POST",headers:{...p(s)}});if(!e.ok){const o=await h(e);throw new Error(o)}return await e.json()}async function d(t,s){const e=await fetch(`${n}/posts/${t}/likes`,{method:"DELETE",headers:{...p(s)}});if(!e.ok){const o=await h(e);throw new Error(o)}return await e.json()}async function x(t,s){const e=await fetch(`${n}/posts/${t}`,{method:"DELETE",headers:{...p(s)}});if(!e.ok){const o=await h(e);throw new Error(o)}}async function h(t){try{const s=await t.json();return typeof s=="object"&&s&&"message"in s?String(s.message):t.statusText||w.global.t("common.serverError")}catch{return t.statusText||w.global.t("common.serverError")}}const L=m("posts",{state:()=>({posts:l("posts",[]),loaded:!1,favorites:l("favorites",{}),likes:l("likes",{}),page:1,pageSize:10,hasMore:!0,loading:!1}),getters:{categories(t){return[...new Set(t.posts.map(s=>s.category))]},tags(t){return[...new Set(t.posts.flatMap(s=>s.tags))]}},actions:{async ensureLoaded(t=!1){this.loaded&&!t||(await this.fetchNextPage(!0),this.loaded=!0)},async fetchNextPage(t=!1){if(!this.loading&&(t&&(this.posts=[],this.page=1,this.hasMore=!0),!!this.hasMore)){this.loading=!0;try{const s=await P(this.page,this.pageSize);t?this.posts=s:this.posts=[...this.posts,...s.filter(e=>!this.posts.some(o=>o.id===e.id))],a("posts",this.posts),s.length<this.pageSize?this.hasMore=!1:this.page+=1}finally{this.loading=!1}}},async fetchById(t){const s=this.posts.find(o=>o.id===t);if(s)return s;const e=await E(t);return this.posts.push(e),a("posts",this.posts),e},async create(t){const s=f().token,e=await S(t,s);return this.posts.unshift(e),a("posts",this.posts),e},async update(t,s){const e=f().token,o=await $(t,s,e);return this.posts=this.posts.map(i=>i.id===t?o:i),a("posts",this.posts),o},async remove(t){const s=f().token,e=[...this.posts];this.posts=this.posts.filter(o=>o.id!==t),a("posts",this.posts);try{await x(t,s)}catch(o){throw this.posts=e,a("posts",this.posts),o}},async toggleLike(t){const e=f().token;if(!e)throw new Error("LOGIN_REQUIRED");const o=!this.likes[t],i=o?1:-1;this.likes[t]=o,a("likes",this.likes);const c=this.posts.findIndex(r=>r.id===t);if(c===-1){try{o?await g(t,e):await d(t,e)}catch(r){throw this.likes[t]=!o,a("likes",this.likes),r}return}const u=this.posts[c],k=u.likes??0,y={...u,likes:Math.max(0,k+i)};this.posts.splice(c,1,y),a("posts",this.posts);try{const r=o?await g(t,e):await d(t,e);this.posts.splice(c,1,r),a("posts",this.posts)}catch(r){throw this.posts.splice(c,1,u),this.likes[t]=!o,a("likes",this.likes),r}}}});export{L as u};
